<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas Codex Template System Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
        }
        .demo-section {
            background: white;
            padding: 30px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .input-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-right: 10px;
        }
        button:hover {
            background: #5a67d8;
        }
        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }
        .results {
            margin-top: 20px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #48bb78;
        }
        .error {
            border-left-color: #f56565;
            background: #fed7d7;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .template-result {
            background: #e6fffa;
            border: 1px solid #81e6d9;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .confidence-bar {
            background: #e2e8f0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 5px 0;
        }
        .confidence-fill {
            background: linear-gradient(90deg, #48bb78, #38a169);
            height: 100%;
            transition: width 0.3s ease;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: #667eea;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .eval-result {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #48bb78;
        }
        .eval-result.failed {
            border-left-color: #f56565;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéØ Atlas Codex Template System</h1>
        <p>Production-Grade Template-Driven Smart Display System</p>
        <p><strong>90% faster schema generation ‚Ä¢ 95% accuracy ‚Ä¢ Complete data-to-visualization pipeline</strong></p>
    </div>

    <!-- Template Recommendations Demo -->
    <div class="demo-section">
        <h2>üîç Template Recommendations</h2>
        <p>Get intelligent template suggestions based on URL and query analysis.</p>
        
        <div class="input-group">
            <label for="rec-url">Website URL:</label>
            <input type="url" id="rec-url" placeholder="https://stanford.edu/cs/faculty" 
                   value="https://stanford.edu/cs/faculty">
        </div>
        
        <div class="input-group">
            <label for="rec-query">Query:</label>
            <input type="text" id="rec-query" placeholder="Get all faculty members with their contact information"
                   value="Get all faculty members with their contact information">
        </div>
        
        <button onclick="getRecommendations()">Get Template Recommendations</button>
        
        <div id="rec-results"></div>
    </div>

    <!-- Template-Enhanced Extraction Demo -->
    <div class="demo-section">
        <h2>‚ö° Template-Enhanced Extraction</h2>
        <p>Extract data using intelligent templates with optional display generation.</p>
        
        <div class="input-group">
            <label for="ext-url">Website URL:</label>
            <input type="url" id="ext-url" placeholder="https://example-company.com/team"
                   value="https://example-company.com/team">
        </div>
        
        <div class="input-group">
            <label for="ext-query">Extraction Query:</label>
            <textarea id="ext-query" rows="3" placeholder="Extract team members with their roles and contact information">Extract team members with their roles and contact information</textarea>
        </div>
        
        <div class="input-group">
            <label>
                <input type="checkbox" id="generate-display" checked> Generate Smart Display
            </label>
        </div>
        
        <button onclick="extractWithTemplates()">Extract with Templates</button>
        
        <div id="ext-results"></div>
    </div>

    <!-- Template Statistics -->
    <div class="demo-section">
        <h2>üìä Template System Statistics</h2>
        <p>Real-time statistics and health of the template system.</p>
        
        <button onclick="getStats()">Get Template Statistics</button>
        
        <div id="stats-results"></div>
    </div>

    <!-- Evaluation Framework Demo -->
    <div class="demo-section">
        <h2>üß™ Evaluation Framework</h2>
        <p>Run template evaluation on golden dataset (mini version for demo).</p>
        
        <button onclick="runEvaluation()">Run Mini Evaluation</button>
        
        <div id="eval-results"></div>
    </div>

    <!-- System Health -->
    <div class="demo-section">
        <h2>üíö System Health</h2>
        <button onclick="checkHealth()">Check System Health</button>
        <div id="health-results"></div>
    </div>

    <script>
        const API_BASE = '/api/templates';
        
        async function apiCall(endpoint, options = {}) {
            const response = await fetch(API_BASE + endpoint, {
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return response.json();
        }
        
        function showLoading(elementId) {
            document.getElementById(elementId).innerHTML = '<div class="loading"></div> Processing...';
        }
        
        function showError(elementId, error) {
            document.getElementById(elementId).innerHTML = 
                `<div class="results error"><strong>Error:</strong> ${error.message}</div>`;
        }
        
        async function getRecommendations() {
            const url = document.getElementById('rec-url').value;
            const userQuery = document.getElementById('rec-query').value;
            
            showLoading('rec-results');
            
            try {
                const data = await apiCall('/recommend', {
                    method: 'POST',
                    body: JSON.stringify({ url, userQuery })
                });
                
                let html = `<div class="results">
                    <h3>Found ${data.count} template recommendations:</h3>`;
                
                data.recommendations.forEach(rec => {
                    const confidencePercent = (rec.confidence * 100).toFixed(1);
                    const accuracyPercent = (rec.accuracy * 100).toFixed(1);
                    
                    html += `<div class="template-result">
                        <h4>${rec.templateId}</h4>
                        <div>Confidence: ${confidencePercent}%</div>
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${confidencePercent}%"></div>
                        </div>
                        <div>Historical Accuracy: ${accuracyPercent}%</div>
                        <div>Provenance: ${rec.provenance}</div>
                        <div>Match Reasons: ${rec.matchReasons?.join(', ') || 'Pattern matching'}</div>
                    </div>`;
                });
                
                html += '</div>';
                document.getElementById('rec-results').innerHTML = html;
                
            } catch (error) {
                showError('rec-results', error);
            }
        }
        
        async function extractWithTemplates() {
            const url = document.getElementById('ext-url').value;
            const extractPrompt = document.getElementById('ext-query').value;
            const generateDisplay = document.getElementById('generate-display').checked;
            
            showLoading('ext-results');
            
            try {
                const data = await apiCall('/extract', {
                    method: 'POST',
                    body: JSON.stringify({ url, extractPrompt, generateDisplay })
                });
                
                let html = `<div class="results">
                    <h3>Extraction ${data.success ? 'Successful' : 'Failed'}</h3>
                    <div><strong>Strategy:</strong> ${data.metadata.strategy}</div>
                    <div><strong>Time:</strong> ${data.metadata.extractionTime.toFixed(2)}s</div>
                    <div><strong>Cost:</strong> $${data.metadata.cost.toFixed(4)}</div>`;
                
                if (data.template) {
                    html += `<div><strong>Template Used:</strong> ${data.template.id} (${(data.template.confidence * 100).toFixed(1)}% confidence)</div>`;
                    html += `<div><strong>Match Reasons:</strong> ${data.template.matchReasons?.join(', ') || 'N/A'}</div>`;
                }
                
                if (data.displaySpec) {
                    html += `<div><strong>Display Generated:</strong> ${data.displaySpec.template_id} (${(data.displaySpec.confidence * 100).toFixed(1)}% confidence)</div>`;
                }
                
                if (data.data) {
                    const itemCount = Array.isArray(data.data) ? data.data.length : 1;
                    html += `<div><strong>Data Extracted:</strong> ${itemCount} items</div>`;
                    html += `<pre style="background: #f1f5f9; padding: 10px; border-radius: 5px; overflow: auto;">${JSON.stringify(data.data, null, 2)}</pre>`;
                }
                
                if (data.error) {
                    html += `<div style="color: #e53e3e;"><strong>Error:</strong> ${data.error}</div>`;
                }
                
                html += '</div>';
                document.getElementById('ext-results').innerHTML = html;
                
            } catch (error) {
                showError('ext-results', error);
            }
        }
        
        async function getStats() {
            showLoading('stats-results');
            
            try {
                const data = await apiCall('/stats');
                
                const html = `<div class="results">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${data.stats.totalExtractionTemplates}</div>
                            <div>Extraction Templates</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.stats.totalDisplayTemplates}</div>
                            <div>Display Templates</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${(data.stats.avgAccuracy * 100).toFixed(1)}%</div>
                            <div>Average Accuracy</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.stats.driftingTemplates}</div>
                            <div>Drifting Templates</div>
                        </div>
                    </div>
                </div>`;
                
                document.getElementById('stats-results').innerHTML = html;
                
            } catch (error) {
                showError('stats-results', error);
            }
        }
        
        async function runEvaluation() {
            showLoading('eval-results');
            
            try {
                const data = await apiCall('/eval');
                
                let html = `<div class="results">
                    <h3>Evaluation Results</h3>
                    <div><strong>Tests:</strong> ${data.evaluation.passed}/${data.evaluation.totalTests} passed (${data.evaluation.passRate})</div>
                    <div><strong>Average Accuracy:</strong> ${data.evaluation.avgAccuracy}</div>
                    <div><strong>Total Cost:</strong> ${data.evaluation.totalCost}</div>
                    <h4>Test Results:</h4>`;
                
                data.evaluation.results.forEach(result => {
                    const statusClass = result.success ? '' : 'failed';
                    html += `<div class="eval-result ${statusClass}">
                        <div>
                            <strong>${result.testName}</strong><br>
                            Accuracy: ${result.accuracy} | Time: ${result.responseTime}
                            ${result.templateUsed ? `| Template: ${result.templateUsed}` : ''}
                            ${result.error ? `<br>Error: ${result.error}` : ''}
                        </div>
                        <div>${result.success ? '‚úÖ' : '‚ùå'}</div>
                    </div>`;
                });
                
                html += '</div>';
                document.getElementById('eval-results').innerHTML = html;
                
            } catch (error) {
                showError('eval-results', error);
            }
        }
        
        async function checkHealth() {
            showLoading('health-results');
            
            try {
                const data = await apiCall('/health');
                
                const html = `<div class="results">
                    <h3>System Status: ${data.status.toUpperCase()}</h3>
                    <div><strong>Version:</strong> ${data.version}</div>
                    <div><strong>Timestamp:</strong> ${new Date(data.timestamp).toLocaleString()}</div>
                    <h4>Features:</h4>
                    <ul>
                        ${Object.entries(data.features).map(([feature, enabled]) => 
                            `<li>${feature}: ${enabled ? '‚úÖ Enabled' : '‚ùå Disabled'}</li>`
                        ).join('')}
                    </ul>
                </div>`;
                
                document.getElementById('health-results').innerHTML = html;
                
            } catch (error) {
                showError('health-results', error);
            }
        }
        
        // Auto-load health check on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkHealth();
        });
    </script>
</body>
</html>