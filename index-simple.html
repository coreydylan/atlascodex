<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas Codex - Web Scraping Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .mini-loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const API_BASE = 'https://gxi4vg8gla.execute-api.us-west-2.amazonaws.com/dev/api';
            
            // State management
            const [activeTab, setActiveTab] = useState('scrape');
            const [loading, setLoading] = useState(false);
            const [jobs, setJobs] = useState([]);
            const [results, setResults] = useState({});
            const [expandedJobs, setExpandedJobs] = useState({});
            
            // Form states
            const [scrapeUrl, setScrapeUrl] = useState('');
            const [crawlUrl, setCrawlUrl] = useState('');
            const [extractUrl, setExtractUrl] = useState('');
            const [extractPrompt, setExtractPrompt] = useState('Extract all relevant information from this page');
            const [extractSchema, setExtractSchema] = useState('{\n  "title": "string",\n  "price": "number",\n  "description": "string"\n}');
            
            // Options
            const [scrapeOptions, setScrapeOptions] = useState({
                waitFor: 'load',
                screenshot: false,
                fullPage: false
            });
            
            const [crawlOptions, setCrawlOptions] = useState({
                maxPages: 10,
                maxDepth: 2,
                waitBetween: 1000
            });

            // Poll for job status
            useEffect(() => {
                const interval = setInterval(async () => {
                    const pendingJobs = jobs.filter(j => j.status === 'pending' || j.status === 'processing');
                    
                    for (const job of pendingJobs) {
                        try {
                            const response = await fetch(`${API_BASE}/${job.type}/${job.jobId}`, {
                                headers: { 'X-Api-Key': 'test-key-123' }
                            });
                            const data = await response.json();
                            
                            // Update results
                            setResults(prev => ({
                                ...prev,
                                [job.jobId]: data
                            }));
                            
                            // Update job status
                            setJobs(prev => prev.map(j => 
                                j.jobId === job.jobId ? { 
                                    ...j, 
                                    status: data.status,
                                    updatedAt: new Date().toISOString()
                                } : j
                            ));
                        } catch (error) {
                            console.error('Failed to fetch job status:', error);
                        }
                    }
                }, 2000);

                return () => clearInterval(interval);
            }, [jobs]);

            const handleScrape = async () => {
                if (!scrapeUrl) {
                    alert('Please enter a URL');
                    return;
                }
                
                setLoading(true);
                try {
                    const response = await fetch(`${API_BASE}/scrape`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'X-Api-Key': 'test-key-123'
                        },
                        body: JSON.stringify({
                            url: scrapeUrl,
                            ...scrapeOptions
                        })
                    });
                    const data = await response.json();
                    
                    setJobs(prev => [{
                        ...data,
                        type: 'scrape',
                        url: scrapeUrl,
                        createdAt: new Date().toISOString()
                    }, ...prev]);
                    
                    // Auto-expand new job
                    setExpandedJobs(prev => ({ ...prev, [data.jobId]: true }));
                    setScrapeUrl('');
                } catch (error) {
                    console.error('Scrape error:', error);
                    alert('Failed to create scrape job');
                } finally {
                    setLoading(false);
                }
            };

            const handleCrawl = async () => {
                if (!crawlUrl) {
                    alert('Please enter a URL');
                    return;
                }
                
                setLoading(true);
                try {
                    const response = await fetch(`${API_BASE}/crawl`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'X-Api-Key': 'test-key-123'
                        },
                        body: JSON.stringify({
                            url: crawlUrl,
                            ...crawlOptions
                        })
                    });
                    const data = await response.json();
                    
                    setJobs(prev => [{
                        ...data,
                        type: 'crawl',
                        url: crawlUrl,
                        createdAt: new Date().toISOString()
                    }, ...prev]);
                    
                    setExpandedJobs(prev => ({ ...prev, [data.jobId]: true }));
                    setCrawlUrl('');
                } catch (error) {
                    console.error('Crawl error:', error);
                    alert('Failed to create crawl job');
                } finally {
                    setLoading(false);
                }
            };

            const handleExtract = async () => {
                if (!extractUrl) {
                    alert('Please enter a URL');
                    return;
                }
                
                setLoading(true);
                try {
                    const response = await fetch(`${API_BASE}/extract`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'X-Api-Key': 'test-key-123'
                        },
                        body: JSON.stringify({
                            url: extractUrl,
                            prompt: extractPrompt,
                            schema: JSON.parse(extractSchema)
                        })
                    });
                    const data = await response.json();
                    
                    setJobs(prev => [{
                        ...data,
                        type: 'extract',
                        url: extractUrl,
                        createdAt: new Date().toISOString()
                    }, ...prev]);
                    
                    setExpandedJobs(prev => ({ ...prev, [data.jobId]: true }));
                    setExtractUrl('');
                } catch (error) {
                    console.error('Extract error:', error);
                    alert('Failed to create extract job');
                } finally {
                    setLoading(false);
                }
            };

            const downloadContent = (content, filename) => {
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <div className="gradient-bg text-white p-6 shadow-lg">
                        <div className="max-w-7xl mx-auto">
                            <h1 className="text-3xl font-bold">Atlas Codex</h1>
                            <p className="text-purple-100 mt-1">High-Performance Web Scraping Platform</p>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="max-w-7xl mx-auto p-6">
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            
                            {/* Input Panel */}
                            <div className="glass-effect rounded-xl p-6">
                                {/* Tabs */}
                                <div className="flex space-x-2 mb-6">
                                    {['scrape', 'crawl', 'extract'].map(tab => (
                                        <button
                                            key={tab}
                                            onClick={() => setActiveTab(tab)}
                                            className={`px-4 py-2 rounded-lg font-medium transition-all ${
                                                activeTab === tab ? 'tab-active' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                            }`}
                                        >
                                            {tab.charAt(0).toUpperCase() + tab.slice(1)}
                                        </button>
                                    ))}
                                </div>

                                {/* Scrape Tab */}
                                {activeTab === 'scrape' && (
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">URL to Scrape</label>
                                            <input
                                                type="url"
                                                value={scrapeUrl}
                                                onChange={(e) => setScrapeUrl(e.target.value)}
                                                placeholder="https://example.com"
                                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                            />
                                        </div>
                                        
                                        <div className="space-y-2">
                                            <label className="flex items-center">
                                                <input
                                                    type="checkbox"
                                                    checked={scrapeOptions.screenshot}
                                                    onChange={(e) => setScrapeOptions(prev => ({
                                                        ...prev,
                                                        screenshot: e.target.checked
                                                    }))}
                                                    className="mr-2"
                                                />
                                                <span className="text-sm">Take screenshot</span>
                                            </label>
                                            
                                            {scrapeOptions.screenshot && (
                                                <label className="flex items-center ml-6">
                                                    <input
                                                        type="checkbox"
                                                        checked={scrapeOptions.fullPage}
                                                        onChange={(e) => setScrapeOptions(prev => ({
                                                            ...prev,
                                                            fullPage: e.target.checked
                                                        }))}
                                                        className="mr-2"
                                                    />
                                                    <span className="text-sm">Full page screenshot</span>
                                                </label>
                                            )}
                                        </div>
                                        
                                        <button
                                            onClick={handleScrape}
                                            disabled={loading || !scrapeUrl}
                                            className="w-full py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg font-medium hover:from-purple-700 hover:to-purple-800 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                                        >
                                            {loading ? 'Processing...' : 'Start Scraping'}
                                        </button>
                                    </div>
                                )}

                                {/* Crawl Tab */}
                                {activeTab === 'crawl' && (
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Starting URL</label>
                                            <input
                                                type="url"
                                                value={crawlUrl}
                                                onChange={(e) => setCrawlUrl(e.target.value)}
                                                placeholder="https://example.com"
                                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                            />
                                        </div>
                                        
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Max Pages</label>
                                                <input
                                                    type="number"
                                                    value={crawlOptions.maxPages}
                                                    onChange={(e) => setCrawlOptions(prev => ({
                                                        ...prev,
                                                        maxPages: parseInt(e.target.value)
                                                    }))}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Max Depth</label>
                                                <input
                                                    type="number"
                                                    value={crawlOptions.maxDepth}
                                                    onChange={(e) => setCrawlOptions(prev => ({
                                                        ...prev,
                                                        maxDepth: parseInt(e.target.value)
                                                    }))}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                                />
                                            </div>
                                        </div>
                                        
                                        <button
                                            onClick={handleCrawl}
                                            disabled={loading || !crawlUrl}
                                            className="w-full py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg font-medium hover:from-purple-700 hover:to-purple-800 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                                        >
                                            {loading ? 'Processing...' : 'Start Crawling'}
                                        </button>
                                    </div>
                                )}

                                {/* Extract Tab */}
                                {activeTab === 'extract' && (
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">URL</label>
                                            <input
                                                type="url"
                                                value={extractUrl}
                                                onChange={(e) => setExtractUrl(e.target.value)}
                                                placeholder="https://example.com/product"
                                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                            />
                                        </div>
                                        
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Extraction Prompt</label>
                                            <textarea
                                                value={extractPrompt}
                                                onChange={(e) => setExtractPrompt(e.target.value)}
                                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                                rows="2"
                                            />
                                        </div>
                                        
                                        <button
                                            onClick={handleExtract}
                                            disabled={loading || !extractUrl}
                                            className="w-full py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg font-medium hover:from-purple-700 hover:to-purple-800 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                                        >
                                            {loading ? 'Processing...' : 'Extract Data'}
                                        </button>
                                    </div>
                                )}
                            </div>

                            {/* Results Panel */}
                            <div className="glass-effect rounded-xl p-6">
                                <div className="flex items-center justify-between mb-4">
                                    <h2 className="text-xl font-semibold text-gray-800">Job Results</h2>
                                    {jobs.filter(j => j.status === 'pending' || j.status === 'processing').length > 0 && (
                                        <span className="flex items-center text-sm text-purple-600">
                                            <div className="mini-loader mr-2"></div>
                                            {jobs.filter(j => j.status === 'pending' || j.status === 'processing').length} active
                                        </span>
                                    )}
                                </div>
                                
                                {jobs.length === 0 ? (
                                    <div className="text-center py-12 text-gray-500">
                                        <svg className="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                        </svg>
                                        <p className="text-lg mb-2">No jobs yet</p>
                                        <p className="text-sm">Start a scraping job to see results here</p>
                                    </div>
                                ) : (
                                    <div className="space-y-3 max-h-[600px] overflow-y-auto">
                                        {jobs.map(job => {
                                            const result = results[job.jobId];
                                            const isExpanded = expandedJobs[job.jobId];
                                            
                                            return (
                                                <div 
                                                    key={job.jobId} 
                                                    className={`border rounded-lg transition-all ${
                                                        job.status === 'failed' ? 'border-red-200 bg-red-50' :
                                                        job.status === 'completed' ? 'border-green-200 bg-green-50' :
                                                        job.status === 'processing' ? 'border-blue-200 bg-blue-50' :
                                                        'border-yellow-200 bg-yellow-50'
                                                    }`}
                                                >
                                                    {/* Job Header - Clickable */}
                                                    <div 
                                                        className="p-4 cursor-pointer hover:bg-white/50 transition-colors"
                                                        onClick={() => setExpandedJobs(prev => ({
                                                            ...prev,
                                                            [job.jobId]: !prev[job.jobId]
                                                        }))}
                                                    >
                                                        <div className="flex items-center justify-between">
                                                            <div className="flex items-center space-x-3">
                                                                {/* Status Icon */}
                                                                {job.status === 'completed' && (
                                                                    <svg className="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                                                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                                                                    </svg>
                                                                )}
                                                                {job.status === 'failed' && (
                                                                    <svg className="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                                                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                                                                    </svg>
                                                                )}
                                                                {(job.status === 'pending' || job.status === 'processing') && (
                                                                    <div className="mini-loader"></div>
                                                                )}
                                                                
                                                                {/* Job Info */}
                                                                <div className="flex-1">
                                                                    <div className="flex items-center space-x-2">
                                                                        <span className="font-medium text-gray-900">
                                                                            {job.type.toUpperCase()}
                                                                        </span>
                                                                        <span className={`px-2 py-0.5 text-xs rounded-full font-medium ${
                                                                            job.status === 'completed' ? 'bg-green-200 text-green-800' :
                                                                            job.status === 'failed' ? 'bg-red-200 text-red-800' :
                                                                            job.status === 'processing' ? 'bg-blue-200 text-blue-800' :
                                                                            'bg-yellow-200 text-yellow-800'
                                                                        }`}>
                                                                            {job.status}
                                                                        </span>
                                                                    </div>
                                                                    <div className="text-xs text-gray-600 mt-1 truncate">
                                                                        {job.url}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            {/* Expand Icon */}
                                                            <svg className={`w-5 h-5 text-gray-400 transform transition-transform ${isExpanded ? 'rotate-180' : ''}`} fill="currentColor" viewBox="0 0 20 20">
                                                                <path fillRule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clipRule="evenodd" />
                                                            </svg>
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Expanded Content */}
                                                    {isExpanded && (
                                                        <div className="border-t border-gray-200 p-4 bg-white/70">
                                                            <div className="text-xs text-gray-500 mb-3 font-mono">
                                                                ID: {job.jobId}
                                                            </div>
                                                            
                                                            {/* Processing Status */}
                                                            {(job.status === 'pending' || job.status === 'processing') && (
                                                                <div className="flex items-center space-x-2 text-sm text-blue-600 pulse">
                                                                    <div className="mini-loader"></div>
                                                                    <span>Processing... This may take a few moments.</span>
                                                                </div>
                                                            )}
                                                            
                                                            {/* Error Display */}
                                                            {result?.error && (
                                                                <div className="p-3 bg-red-100 border border-red-300 rounded-lg mb-3">
                                                                    <div className="flex items-start">
                                                                        <svg className="w-5 h-5 text-red-600 mt-0.5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                                                            <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                                                                        </svg>
                                                                        <div>
                                                                            <p className="text-sm font-medium text-red-800">Error occurred</p>
                                                                            <p className="text-sm text-red-700 mt-1">{result.error}</p>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            
                                                            {/* Success Results */}
                                                            {result?.status === 'completed' && result?.result && (
                                                                <div className="space-y-4">
                                                                    {/* Metadata */}
                                                                    {result.result.metadata && (
                                                                        <div>
                                                                            <h4 className="text-sm font-semibold text-gray-700 mb-2">Page Information</h4>
                                                                            <div className="bg-gray-50 rounded-lg p-3 text-sm space-y-1">
                                                                                {result.result.metadata.title && (
                                                                                    <div><span className="font-medium">Title:</span> {result.result.metadata.title}</div>
                                                                                )}
                                                                                {result.result.metadata.description && (
                                                                                    <div><span className="font-medium">Description:</span> {result.result.metadata.description}</div>
                                                                                )}
                                                                                <div><span className="font-medium">Status:</span> {result.result.status || 'N/A'}</div>
                                                                                <div><span className="font-medium">Method:</span> {result.result.method || 'N/A'}</div>
                                                                            </div>
                                                                        </div>
                                                                    )}
                                                                    
                                                                    {/* Extracted Data */}
                                                                    {result.result.extractedData && (
                                                                        <div>
                                                                            <h4 className="text-sm font-semibold text-gray-700 mb-2">Extracted Data</h4>
                                                                            <div className="bg-gray-900 rounded-lg p-3 overflow-x-auto">
                                                                                <pre className="text-xs text-green-400 font-mono">
                                                                                    {JSON.stringify(result.result.extractedData, null, 2)}
                                                                                </pre>
                                                                            </div>
                                                                        </div>
                                                                    )}
                                                                    
                                                                    {/* Crawl Results */}
                                                                    {result.result.pages && (
                                                                        <div>
                                                                            <h4 className="text-sm font-semibold text-gray-700 mb-2">
                                                                                Crawled {result.result.pagesVisited} Pages
                                                                            </h4>
                                                                            <div className="bg-gray-50 rounded-lg p-3 max-h-40 overflow-y-auto space-y-1">
                                                                                {result.result.pages.map((page, idx) => (
                                                                                    <div key={idx} className="text-sm">
                                                                                        <span className="text-gray-500">Depth {page.depth}:</span> {page.title || page.url}
                                                                                    </div>
                                                                                ))}
                                                                            </div>
                                                                        </div>
                                                                    )}
                                                                    
                                                                    {/* Content Preview */}
                                                                    {result.result.markdown && (
                                                                        <div>
                                                                            <div className="flex items-center justify-between mb-2">
                                                                                <h4 className="text-sm font-semibold text-gray-700">Content Preview</h4>
                                                                                <button 
                                                                                    onClick={() => downloadContent(result.result.markdown, `${job.jobId}.md`)}
                                                                                    className="text-xs text-purple-600 hover:text-purple-700 font-medium"
                                                                                >
                                                                                    Download Full
                                                                                </button>
                                                                            </div>
                                                                            <div className="bg-gray-50 rounded-lg p-3 max-h-60 overflow-y-auto">
                                                                                <pre className="text-sm text-gray-700 whitespace-pre-wrap font-sans">
                                                                                    {result.result.markdown.substring(0, 1000)}
                                                                                    {result.result.markdown.length > 1000 && '...'}
                                                                                </pre>
                                                                            </div>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>