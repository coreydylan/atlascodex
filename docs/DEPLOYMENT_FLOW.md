# Atlas Codex Deployment Flow

## Quick Reference

### Environment Management
```bash
# Sync environment variables
npm run sync:dev   # Switch to development
npm run sync:prod  # Switch to production

# Deploy with auto-sync
npm run deploy:dev   # Deploy to dev (auto-syncs first)
npm run deploy:prod  # Deploy to production (auto-syncs first)
```

### Branch Protection Settings (Production)
- ✅ Required status checks: "Test & Validate" must pass
- ✅ No review requirement: Can merge own PRs
- ✅ Require last push approval: Prevents stale merges
- ✅ Conversation resolution: All comments must be resolved
- ✅ Admin bypass allowed: Use `--admin` flag when needed
- ❌ Admin enforcement OFF: Admins can bypass

### PR Merge Workflow
```bash
# Standard merge (all checks must pass)
gh pr merge <number> --merge

# Emergency admin merge (bypass protections)
gh pr merge <number> --merge --admin

# Auto-merge when checks pass
gh pr merge <number> --auto --merge
```

## Environment Variables Structure

### Development
- API URL: `https://gxi4vg8gla.execute-api.us-west-2.amazonaws.com/dev`
- API Key: `test-key-123`
- Stage: `dev`

### Production
- API URL: `https://s7vo1vic8b.execute-api.us-west-2.amazonaws.com/production`
- API Key: `atlas-prod-key-2024`
- Stage: `production`

## File Locations
- **Sync Script**: `scripts/sync-env.js`
- **Root Config**: `vercel.json` (main Vercel config)
- **Frontend Config**: `packages/frontend/.env.*` (generated by sync)
- **Backend Config**: `.env.*` (generated by sync)
- **Serverless**: `serverless.yml` (auto-updated by sync)

## Troubleshooting

### Vercel Deployment Failed
1. Run `npm run sync:prod` to ensure env vars are correct
2. Check that `packages/frontend/vercel.json` doesn't exist (should be deleted)
3. Verify root `vercel.json` has correct `VITE_*` variables

### PR Won't Merge
1. Check all required status checks passed: `gh pr checks <number>`
2. Resolve all conversations: `gh pr view <number> --web`
3. Use admin merge if needed: `gh pr merge <number> --admin --merge`

### Environment Mismatch
1. Always run sync before deploy: `npm run sync:prod`
2. Check current environment: `cat vercel.json | grep VITE_API_URL`
3. Verify with health check:
   - Dev: `curl https://gxi4vg8gla.execute-api.us-west-2.amazonaws.com/dev/health`
   - Prod: `curl https://s7vo1vic8b.execute-api.us-west-2.amazonaws.com/production/health`

## Full Production Deployment Process

```bash
# 1. Ensure you're on the right branch
git checkout production

# 2. Merge latest changes from main
git merge main

# 3. Sync production environment
npm run sync:prod

# 4. Run tests
npm run test:accuracy:critical

# 5. Deploy to production
npm run deploy:prod

# 6. Verify deployment
curl https://s7vo1vic8b.execute-api.us-west-2.amazonaws.com/production/health
```

## Emergency Rollback

```bash
# Via GitHub Actions
gh workflow run deploy.yml

# Manual Lambda rollback
aws lambda update-alias \
  --function-name atlas-codex-production-api \
  --name prod \
  --function-version <previous-version>
```

---
*Last updated: September 6, 2025*
*Auto-generated from production fix deployment*